<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Email Verifier</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    #drop-zone {
      border: 2px dashed #ccc;
      padding: 40px;
      width: 400px;
      margin: auto;
      background: #f9f9f9;
      cursor: pointer;
    }
    #drop-zone.hover { border-color: #000; }
    #jobs { max-width: 600px; margin: 40px auto; text-align: left; }
    .job {
      border: 1px solid #eee;
      background: #fff;
      border-radius: 6px;
      margin-bottom: 16px;
      padding: 12px 16px;
      position: relative;
    }
    .job h4 { margin: 0 0 8px 0; }
    .job small {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 14px;
      color: #999
    }
    .log-box {
      background: #f3f3f3;
      margin-top: 8px;
      padding: 8px;
      font-family: monospace;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-line;
    }
    .progress-bar {
      background: #eee;
      height: 8px;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-bar-inner {
      height: 100%;
      background: #4caf50;
      width: 0%;
      transition: width 0.4s ease;
    }
    .download-links {
      margin-top: 8px;
      font-size: 14px;
    }
    .download-links a {
      margin-right: 4px;
    }
    #file-input {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Email Verifier</h1>
  <p>Drop your CSV file with an "email" column, or click below to select.</p>
  <div id="drop-zone">Drop CSV here or click to upload</div>
  <input type="file" id="file-input" accept=".csv" />

  <div id="jobs"></div>

  <script>
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const jobsContainer = document.getElementById('jobs');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('hover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('hover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('hover');
      const file = e.dataTransfer.files[0];
      if (file) {
        uploadFile(file);
      }
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) {
        uploadFile(file);
      }
    });

    function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);

      // create job in UI immediately
      const jobId = 'job_' + Math.random().toString(36).substring(2, 9);
      const jobEl = document.createElement('div');
      jobEl.className = 'job';
      jobEl.id = jobId;
      jobEl.innerHTML = `
        <h4>${file.name}</h4>
        <small>Processing...</small>
        <div class="progress-bar"><div class="progress-bar-inner" style="width:0%"></div></div>
        <div class="log-box">Uploading...</div>
      `;
      jobsContainer.prepend(jobEl);

      fetch('http://ng8g4c8occ8osck40sscs84g.46.62.238.74.sslip.io/verify', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        console.log('UPLOAD DONE', data);
        // the server returns job_id, we should start polling
        if (data.job_id) {
          startPolling(jobId, data.job_id, file.name);
        } else {
          jobEl.querySelector('.log-box').textContent = 'Error: No job_id returned from server.';
          jobEl.querySelector('small').textContent = 'Error';
        }
      })
      .catch(err => {
        console.error(err);
        jobEl.querySelector('.log-box').textContent = 'Error uploading file.';
        jobEl.querySelector('small').textContent = 'Error';
      });
    }

    function startPolling(jobElementId, serverJobId, filename) {
      const jobEl = document.getElementById(jobElementId);
      const logBox = jobEl.querySelector('.log-box');
      const progressBarInner = jobEl.querySelector('.progress-bar-inner');
      const statusSmall = jobEl.querySelector('small');

      const intervalId = setInterval(() => {
        // progress
        fetch(`http://ng8g4c8occ8osck40sscs84g.46.62.238.74.sslip.io/progress?job_id=${serverJobId}`)
          .then(r => r.json())
          .then(progressData => {
            const pct = progressData.progress || 0;
            progressBarInner.style.width = pct + '%';

            if (pct < 100) {
              statusSmall.textContent = `Processing... (${pct}%)`;
            } else {
              statusSmall.textContent = 'Done';
            }
          });

        // logs
        fetch(`http://ng8g4c8occ8osck40sscs84g.46.62.238.74.sslip.io/log?job_id=${serverJobId}`)
          .then(r => r.json())
          .then(logData => {
            logBox.textContent = logData.logs.join('\n');

            // if done, show download links and stop polling
            if (logData.status === 'done') {
              clearInterval(intervalId);
              statusSmall.textContent = 'Done';
              const pct = 100;
              progressBarInner.style.width = pct + '%';

              jobEl.innerHTML = `
                <h4>${filename}</h4>
                <small>Done</small>
                <div class="progress-bar">
                  <div class="progress-bar-inner" style="width: 100%"></div>
                </div>
                <div class="log-box">${logData.logs.join('<br>')}</div>
                <div class="download-links">
                  <div>
                    <strong>Download results:</strong>
                  </div>
                  <div>
                    <a href="http://ng8g4c8occ8osck40sscs84g.46.62.238.74.sslip.io/download?job_id=${serverJobId}&type=all" target="_blank">All</a> |
                    <a href="http://ng8g4c8occ8osck40sscs84g.46.62.238.74.sslip.io/download?job_id=${serverJobId}&type=valid" target="_blank">Valid Only</a>
                  </div>
                  <div>
                    <a href="http://ng8g4c8occ8osck40sscs84g.46.62.238.74.sslip.io/download?job_id=${serverJobId}&type=risky" target="_blank">Risky Only</a> |
                    <a href="http://ng8g4c8occ8osck40sscs84g.46.62.238.74.sslip.io/download?job_id=${serverJobId}&type=risky_invalid" target="_blank">Risky & Invalid</a>
                  </div>
                </div>
              `;
            }
          });
      }, 1500);
    }
  </script>
</body>
</html>
